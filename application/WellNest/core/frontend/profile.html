{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Page</title>
  <link rel="stylesheet" href="{% static 'profile.css' %}">
  <link rel="stylesheet" href="{% static 'header.css' %}">
  <link rel="stylesheet" href="{% static 'sideNav.css' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
</head>

<body>
  {% csrf_token %}
  <div class="page-container">
    <div id="header">
      <div class="box" id="profile-div">
        <input type="text" id="search-box" placeholder="Search habits or people..." />
        <img src="{% static 'streak-hot.png' %}" alt="streak-hot" id="streak-hot">
            <a href="{% url 'profile' %}"><img src="{% static 'pf.png' %}" href="{% url 'profile' %}" alt="pf icon"id="pf-icon"></a>
      </div>

      <div class="box" id="search-div"></div>
      <div class="box" id="menu-div">
        <img src="{% static 'menu.png' %}" alt="hamburger-menu" id="hamburger-menu">
      </div>
    </div>

    <div id="sideNav">
      <div class="nav-top">
        <div id="icons" style="display: flex; justify-content: space-between; margin-top: -15px;">
          <div id="icons-left">
            <img src="{% static 'wn.png' %}" alt="WN Logo" id="navLogo" style="margin-left: -20px;">
          </div>
          <div id="icons-right">
            <img src="{% static 'menu.png' %}" alt="close-nav" style="width: 40px;" id="close-nav">
          </div>
        </div>

        <a href="{% url 'calendar' %}" class="nav-link">Home</a>
        <a href="{% url 'progress' %}" class="nav-link">Progress</a>
        <a href="{% url 'socials' %}" class="nav-link">Socials</a>
      </div>

      <div class="nav-bottom">
        <a href="{% url 'review' %}" class="nav-link">Review</a>
        <a href="{% url 'about' %}" class="nav-link">About</a>
      </div>
    </div>

    <div class="card">
      <div class="profile-icon">&#128100;</div>
        <form id="profile-form">
          <label>First Name</label>
          <input type="text" id="first-name" name="firstName" required />

          <label>Last Name</label>
          <input type="text" id="last-name" name="lastName" required />

          <label>Email</label>
          <input type="email" id="email" name="email" required />

          <label>Gender</label>
          <select id="gender" name="gender" required>
            <option value="">Select gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>

          <button type="submit" class="save-btn">Save</button>

         <!--Logout-->
          <button type="button" id="logout-btn" class="logout-btn">Log Out</button>
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              const logoutBtn = document.getElementById("logout-btn");
              logoutBtn.addEventListener("click", () => {
                fetch("/logout/", {
                  method: "POST",
                  headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                  }
                }).then(() => {
                  window.location.href = "/calendar/";
                });
              });

              function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                  const cookies = document.cookie.split(";");
                  for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                    }
                  }
                }
                return cookieValue;
              }
            });
          </script>



        </form>


        <button type="button" id="delete-account-btn" class="delete-btn">Delete Account</button>
        <div id="delete-confirm-popup" class="popup hidden">
          <div class="popup-content">
            <strong>Are you sure you want to delete your account?</strong>
            <p>This will remove all your habits, logs, friends, and notifications.</p>
            <button id="confirm-delete">Yes, Delete</button>
            <button id="cancel-delete">Cancel</button>
          </div>
        </div>

    </div>

    <div id="popup" class="popup hidden">
      <div class="popup-content">
        <strong>Information Saved!</strong>
        <button id="close-popup">Close</button>
      </div>
    </div>



  </div>
<!--Delete Account-->

<script>
document.addEventListener("DOMContentLoaded", () => {
  const deleteBtn = document.getElementById("delete-account-btn");
  const confirmPopup = document.getElementById("delete-confirm-popup");
  const confirmDelete = document.getElementById("confirm-delete");
  const cancelDelete = document.getElementById("cancel-delete");

  deleteBtn.addEventListener("click", () => {
    confirmPopup.classList.remove("hidden");
  });

  cancelDelete.addEventListener("click", () => {
    confirmPopup.classList.add("hidden");
  });

  confirmDelete.addEventListener("click", () => {
    fetch("/api/user/delete/", {
      method: "DELETE",
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      }
    })
    .then(res => {
      if (res.status === 204) {
        alert("Account deleted successfully");
        window.location.href = "/signup/";
      } else {
        return res.json();
      }
    })
    .then(err => {
      if (err && err.error) alert("Error: " + err.error);
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

<!--edit account-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch("/api/user/profile/")
    .then(res => res.json())
    .then(data => {
      document.getElementById("first-name").value = data.first_name || "";
      document.getElementById("last-name").value = data.last_name || "";
      document.getElementById("email").value = data.email || "";

      const genderInput = document.getElementById("gender");
      const genderMap = { m: "Male", f: "Female", o: "Other" };
      const genderRaw = (data.gender || "").toLowerCase();  
      genderInput.value = genderMap[genderRaw] || "";
    });

  const form = document.getElementById("profile-form");
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const genderMapReverse = { "Male": "M", "Female": "F", "Other": "O" };
    const payload = {
      first_name: document.getElementById("first-name").value,
      last_name: document.getElementById("last-name").value,
      email: document.getElementById("email").value,
      gender: document.getElementById("gender").value,
    };

    fetch("/api/user/profile/", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("popup").classList.remove("hidden");
    });
  });

  document.getElementById("close-popup").addEventListener("click", function () {
    document.getElementById("popup").classList.add("hidden");
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
  <script src="{% static 'sideNav.js' %}"></script>
  <script src="{% static 'header.js' %}"></script>
</body>

</html>